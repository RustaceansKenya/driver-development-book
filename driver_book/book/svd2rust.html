<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>svd2rust - driver development in Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">INTRO</li><li class="chapter-item expanded "><a href="intro/intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="intro/prerequisites.html"><strong aria-hidden="true">2.</strong> Prerequisites for the Book</a></li><li class="chapter-item expanded affix "><li class="part-title">UNDERSTANDING DRIVERS (theory)</li><li class="chapter-item expanded "><a href="understanding_drivers/understanding_drivers.html"><strong aria-hidden="true">3.</strong> Intro to Drivers</a></li><li class="chapter-item expanded "><a href="understanding_drivers/controlling_the_device_below.html"><strong aria-hidden="true">4.</strong> Role 1: Controlling the device below</a></li><li class="chapter-item expanded "><a href="understanding_drivers/providing_an_interface.html"><strong aria-hidden="true">5.</strong> Role 2: Providing an interface</a></li><li class="chapter-item expanded "><a href="understanding_drivers/types_of_drivers.html"><strong aria-hidden="true">6.</strong> Types of Drivers</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Kernel and Driver Interaction mechanisms</div></li><li class="chapter-item expanded affix "><li class="part-title">BARE METAL PROGRAMMING</li><li class="chapter-item expanded "><a href="bare_metal/the_no_std_preface.html"><strong aria-hidden="true">8.</strong> No std preface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="bare_metal/no_std/the_no_std_intro.html"><strong aria-hidden="true">8.1.</strong> No std</a></li><li class="chapter-item expanded "><a href="bare_metal/no_std/removing_std_lib.html"><strong aria-hidden="true">8.2.</strong> Disabling the Standard Library</a></li><li class="chapter-item expanded "><a href="bare_metal/no_std/pracs_1.html"><strong aria-hidden="true">8.3.</strong> Pracs 1</a></li><li class="chapter-item expanded "><a href="bare_metal/no_std/pracs_2.html"><strong aria-hidden="true">8.4.</strong> Pracs 2</a></li></ol></li><li class="chapter-item expanded "><a href="bare_metal/cross_compilation/cross_compilation.html"><strong aria-hidden="true">9.</strong> Cross-Compilation</a></li><li class="chapter-item expanded "><a href="bare_metal/linking/linking.html"><strong aria-hidden="true">10.</strong> Linking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="bare_metal/linking/rusty_linkers.html"><strong aria-hidden="true">10.1.</strong> Rusty Linkers</a></li></ol></li><li class="chapter-item expanded "><a href="bare_metal/probing/probing_preface.html"><strong aria-hidden="true">11.</strong> Probing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="bare_metal/probing/probing_theory_1.html"><strong aria-hidden="true">11.1.</strong> Theory</a></li><li class="chapter-item expanded "><a href="bare_metal/probing/flashing/flashing_preface.html"><strong aria-hidden="true">11.2.</strong> Flashing</a></li><li class="chapter-item expanded "><a href="udev.html"><strong aria-hidden="true">11.3.</strong> udev</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.4.</strong> probe-rs</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.4.1.</strong> why is my program not flashing?</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.5.</strong> cargo-flash</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.6.</strong> Logging</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.7.</strong> defmt</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> No-std testing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Performance testing</div></li><li class="chapter-item expanded affix "><li class="part-title">ABSTRACTIONS</li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> MMIO programming</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="registers_and_mmio_programming.html"><strong aria-hidden="true">14.1.</strong> Registers and MMIO programming</a></li></ol></li><li class="chapter-item expanded "><a href="knowing_your_hardware.html"><strong aria-hidden="true">15.</strong> The datasheet</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.</strong> Abstraction</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="svd2rust.html" class="active"><strong aria-hidden="true">16.1.</strong> svd2rust</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">THE UART THEORY</li><li class="chapter-item expanded "><div><strong aria-hidden="true">17.</strong> Understanding UART Theory</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Understanding UART physical Implemetation in the esp32</div></li><li class="chapter-item expanded affix "><li class="part-title">THE UART IMPLEMENTATION (naive)</li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> chapters that I dont know their titles</div></li><li class="chapter-item expanded affix "><li class="part-title">THE UART IMPLEMENTATION (less naive)</li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Concurrency and atomic magic</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.</strong> chapters that I dont know their titles</div></li><li class="chapter-item expanded affix "><li class="part-title">OTHER STORIES</li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.</strong> Driver Security</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">22.1.</strong> Common Security Issues in Driver Development</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.2.</strong> Rust's Safety Features for Driver Security</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.3.</strong> Best Practices for Secure Driver Development</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">23.</strong> Case Studies and Examples</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">23.1.</strong> Real-world Driver Development Examples</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">23.2.</strong> Analyzing an Existing Rust Driver</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">24.</strong> Iterative Implementation</div></li><li class="chapter-item expanded affix "><li class="part-title">APPENDIX</li><li class="chapter-item expanded "><a href="notable_crates.html"><strong aria-hidden="true">25.</strong> Notable Crates</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">26.</strong> Notable Learning Resources</div></li><li class="chapter-item expanded "><a href="why_embedded_rust.html"><strong aria-hidden="true">27.</strong> why use Rust?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">28.</strong> Out of topic</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="misc/different_std_libs.html"><strong aria-hidden="true">28.1.</strong> different_std_libs</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">driver development in Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="svd2rust"><a class="header" href="#svd2rust">svd2rust</a></h1>
<p>Once you read the datasheet, and understand the memory mapping, pin-layout and whatever else you wanted to get straight, you begin to safely abstract the board.</p>
<h3 id="svd-files"><a class="header" href="#svd-files">SVD files</a></h3>
<p>An svd file is a file that describes the peripherals of a board using xml. So you could say that an svd file is a board abstracted as an xml template.<br />
SVD is the abbreviation for : System View Description.</p>
<p>The svd file outlines :</p>
<ul>
<li>The boards metadata eg boardname, board version, feature description, vendor name</li>
<li>Major component info : eg CPU_capabilities, Endianness, address_width, added cpu_extensions... </li>
<li>all list of all the peripherals
<ul>
<li>the registers of each peripheral</li>
<li>the functions of each register</li>
<li>the memory address of each register</li>
<li>the read/write access of each register</li>
</ul>
</li>
</ul>
<p>You can find sample svd files <a href="%5Bhttps://github.com/espressif/svd/tree/main/svd%5D">here</a>, they are from the espressif organization.<br />
Here is the esp32C3 svd file that we will be using : <a href="%5Bhttps://github.com/espressif/svd/tree/main/svd%5D">ESP32_C3 svd file</a></p>
<p>Here is a snippet of a sample svd file : </p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;device schemaVersion=&quot;1.1&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xs:noNamespaceSchemaLocation=&quot;CMSIS-SVD_Schema_1_1.xsd&quot;&gt;
  &lt;vendor&gt;ESPRESSIF SYSTEMS (SHANGHAI) CO., LTD.&lt;/vendor&gt;
  &lt;vendorID&gt;ESPRESSIF&lt;/vendorID&gt;
  &lt;name&gt;ESP32-C3&lt;/name&gt;
  &lt;series&gt;ESP32 C-Series&lt;/series&gt;
  &lt;version&gt;17&lt;/version&gt;
  &lt;description&gt;32-bit RISC-V MCU &amp;amp; 2.4 GHz Wi-Fi &amp;amp; Bluetooth 5 (LE)&lt;/description&gt;

  &lt;!-- snip snip snipped some lines --&gt;

  &lt;cpu&gt;
    &lt;name&gt;RV32IMC&lt;/name&gt;
    &lt;revision&gt;r0p0&lt;/revision&gt;
    &lt;endian&gt;little&lt;/endian&gt;
    &lt;mpuPresent&gt;false&lt;/mpuPresent&gt;
    &lt;fpuPresent&gt;false&lt;/fpuPresent&gt;
    &lt;nvicPrioBits&gt;0&lt;/nvicPrioBits&gt;
    &lt;vendorSystickConfig&gt;false&lt;/vendorSystickConfig&gt;
  &lt;/cpu&gt;

  &lt;!-- snip snip snipped some lines --&gt;

   &lt;peripherals&gt;
   
   &lt;!-- here is 1/32 peripherals --&gt;
    &lt;peripheral&gt;
        &lt;name&gt;UART0&lt;/name&gt;
      &lt;description&gt;UART (Universal Asynchronous Receiver-Transmitter) Controller 0&lt;/description&gt;
      &lt;groupName&gt;UART&lt;/groupName&gt;
      &lt;baseAddress&gt;0x60000000&lt;/baseAddress&gt;
      &lt;addressBlock&gt;
        &lt;offset&gt;0x0&lt;/offset&gt;
        &lt;size&gt;0x84&lt;/size&gt;
        &lt;usage&gt;registers&lt;/usage&gt;
      &lt;/addressBlock&gt;
      &lt;interrupt&gt;
        &lt;name&gt;UART0&lt;/name&gt;
        &lt;value&gt;21&lt;/value&gt;
      &lt;/interrupt&gt;
      &lt;registers&gt;
        &lt;register&gt;
          &lt;name&gt;FIFO&lt;/name&gt;
          &lt;description&gt;FIFO data register&lt;/description&gt;
          &lt;addressOffset&gt;0x0&lt;/addressOffset&gt;
          &lt;size&gt;0x20&lt;/size&gt;
          &lt;fields&gt;
            &lt;field&gt;
              &lt;name&gt;RXFIFO_RD_BYTE&lt;/name&gt;
              &lt;description&gt;UART 0 accesses FIFO via this register.&lt;/description&gt;
              &lt;bitOffset&gt;0&lt;/bitOffset&gt;
              &lt;bitWidth&gt;8&lt;/bitWidth&gt;
              &lt;access&gt;read-write&lt;/access&gt;
            &lt;/field&gt;
          &lt;/fields&gt;
        &lt;/register&gt;

        &lt;!-- more registers --&gt;
        &lt;register&gt;
        &lt;/register&gt;
        &lt;/register&gt;
        &lt;!-- more registers --&gt;
    &lt;peripheral&gt;

    &lt;!-- snipped out the other 31 peripherals --&gt;
   &lt;peripherals&gt;
</code></pre>
<h3 id="svd2rust-1"><a class="header" href="#svd2rust-1">svd2Rust</a></h3>
<p>This is a tool that takes in svd files and outputs Rust code that reflects the contents of the svd file.</p>
<h3 id="why-use-svd2rust-instead-of-doing-the-abstraction-manually"><a class="header" href="#why-use-svd2rust-instead-of-doing-the-abstraction-manually">Why use svd2rust instead of doing the abstraction manually?</a></h3>
<p>Before we discuss whether you should do it manually or not. Let's settle out some facts first.<br />
A full-fledged board has many components. The datasheet reference is like &gt;700 pages. These components are dependent on each other.<br />
You get some form of info overload. How can you create complete abstractions if you do not fully understand the board and how they are interdependent on each other? Enter headaches and suicidal thoughts.</p>
<p>If you look at the esp32c3.svd file, you realize it is &gt;35000 lines. But at-least the svd file provides a complete abstraction from the &gt;700 page datasheet.</p>
<h4 id="when-to-do-it-manually"><a class="header" href="#when-to-do-it-manually">When to do it manually</a></h4>
<ol>
<li>When you fully understand all the details about a peripheral</li>
<li>When you also fuly understand all the direct components that the target peripheral depends on.</li>
<li>When you can comfortably abstract the peripheral and its dependents, in a safe way: critical sections, atomics and all that vodoo when accessing registers.</li>
<li>When you do not need to abstract the whole board.</li>
</ol>
<h4 id="when-to-do-it-automatically"><a class="header" href="#when-to-do-it-automatically">When to do it automatically</a></h4>
<ol>
<li>When you dont mind abstracting all the peripherals</li>
<li>When you want a library to automatically implement the access-safety methods of accessing registers. You don't have to implement atomic vodoo on your own.</li>
<li>When you want to use a standard way of abstracting the board. Your whole team uses the same template. Everyone speaks the same language, everyone becomes happy.</li>
</ol>
<h3 id="svd2rust-2"><a class="header" href="#svd2rust-2">svd2rust</a></h3>
<p>To understand svd2rust, let's :</p>
<ol>
<li>read its docs</li>
<li>experiment with it a little</li>
<li>Do our abstractions manually without depending on svd2rust</li>
<li>Go back to svd2rust while fully appreciating all the manual work it does for us </li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="knowing_your_hardware.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="notable_crates.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="knowing_your_hardware.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="notable_crates.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
